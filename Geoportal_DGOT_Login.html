<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Geoportal DGOT Jalisco</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap" rel="stylesheet">

<!-- Leaflet + Draw -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css">
<script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>

<!-- Supabase -->
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<style>
html,body{
  margin:0;height:100%;overflow:hidden;background:#4a4e55;
  font-family:'Montserrat',sans-serif;font-size:16px;
}
#map{width:100%;height:100%;z-index:0;}

.panel{
  position:absolute;top:10px;left:10px;width:360px;
  background:rgba(255,255,255,0.92);border-radius:10px;
  padding:10px;box-shadow:0 0 10px rgba(0,0,0,0.4);
  max-height:92vh;overflow-y:auto;z-index:1500;
}
.panel h3{
  margin:6px 0;background:#59c1b2;color:#fff;padding:6px;
  border-radius:6px;cursor:pointer;font-size:20px;
}
.hidden{display:none;}
input,textarea,select{
  width:100%;margin:4px 0;border:none;border-radius:5px;
  padding:6px;font-size:16px;box-sizing:border-box;
}
button{
  background:#ed8832;color:#fff;border:none;border-radius:6px;
  padding:6px 10px;cursor:pointer;margin-top:4px;font-size:16px;
}
button:hover{opacity:0.9;}
.small{font-size:13px;opacity:0.9}

.layer-row{
  display:flex;align-items:center;gap:8px;justify-content:space-between;
  margin:6px 0;
}
.layer-left{display:flex;align-items:center;gap:6px;}
.layer-controls{display:flex;align-items:center;gap:6px;}
.range{width:100px;vertical-align:middle;}

#logout{
  position:absolute;bottom:10px;right:10px;background:#ed8832;color:#fff;
  border:none;border-radius:6px;padding:8px 14px;cursor:pointer;z-index:2000;
}

/* Seguimiento jer√°rquico */
ul{list-style:none;padding-left:0;margin:0;}
.grupo{padding:4px 0;position:relative;}
.grupo-nombre{cursor:pointer;display:inline-flex;align-items:center;gap:6px;font-weight:600;}
.grupo-nombre:hover{text-decoration:underline;}
.reporte-lista{
  margin-left:25px;margin-top:2px;padding-left:8px;border-left:2px solid rgba(89,193,178,0.4);
  max-height:0;overflow:hidden;transition:max-height 0.25s ease;
}
.reporte-lista.open{max-height:600px;}
.reporte-item{
  display:flex;align-items:center;justify-content:space-between;margin:3px 0;
}
.reporte-inline{
  display:inline-flex;align-items:center;gap:2px; /* *********** ajusta aqu√≠: 0 = pegado / 4 = m√°s separado */
}
.reporte-inline input[type="checkbox"]{
  margin:0; /* *********** mueve arriba/abajo con margin-top:-1px; si lo deseas */
}
.reporte-inline span{margin:0;padding:0;line-height:1.2;font-weight:500;}
.reporte-del{
  background:#ed8832;border:none;color:#fff;border-radius:4px;
  padding:2px 6px;cursor:pointer;font-size:14px;
}
.reporte-del:hover{background:#d56e1e;}

/* Login */
#loginModal{
  position:fixed;top:0;left:0;width:100%;height:100%;
  display:flex;align-items:center;justify-content:center;
  background:rgba(0,0,0,0.6);z-index:3000;
}
#loginBox{
  background:rgba(255,255,255,0.95);padding:25px 35px;border-radius:10px;
  text-align:center;box-shadow:0 0 10px rgba(0,0,0,0.4);
}
.login-field{
  display:flex;align-items:center;justify-content:center;
  border:1px solid #ccc;border-radius:6px;padding:0 8px;
  background:rgba(255,255,255,0.9);
}
#keyPrivacy{border:none;flex:1;padding:8px;font-size:16px;background:transparent;outline:none;}
.eye-btn{background:none;border:none;cursor:pointer;font-size:18px;color:#4a4e55;padding:0;margin-left:6px;}
</style>
</head>
<body>

<div id="map"></div>

<div class="panel" id="panel">
  <!-- MIS REPORTES -->
  <h3 onclick="toggleBox('reportesBox')">Mis reportes</h3>
  <div id="reportesBox" class="hidden">
    <input id="nombre" placeholder="Nombre del solicitante">
    <input id="tipo" placeholder="Tipo de requerimiento">
    <textarea id="comentarios" placeholder="Descripci√≥n o comentarios"></textarea>
    <select id="grupoSelect"></select>
    <div>
      <button onclick="startDraw('Point')">Punto</button>
      <button onclick="startDraw('LineString')">L√≠nea</button>
      <button onclick="startDraw('Polygon')">Pol√≠gono</button>
    </div>
    <button onclick="saveReporte()">Finalizar</button>
  </div>

  <!-- SEGUIMIENTO -->
  <h3 onclick="toggleBox('gruposBox')">Seguimiento de reportes</h3>
  <div id="gruposBox" class="hidden">
    <input id="grupoNombre" placeholder="Nuevo grupo o municipio">
    <button onclick="addGrupo()">Crear grupo</button>
    <ul id="listaGrupos"></ul>
  </div>

  <!-- CAPAS -->
  <h3 onclick="toggleBox('capasBox')">Capas</h3>
  <div id="capasBox" class="hidden">
    <div class="layer-row">
      <div class="layer-left">
        <input type="checkbox" id="chk_barrios" onchange="toggleLayer('barrios')">
        <span>Barrios</span>
      </div>
      <div class="layer-controls">
        <input type="color" id="col_barrios" value="#59c1b2" onchange="updateLayerStyle('barrios')">
        <input type="range" id="op_barrios" class="range" min="0" max="1" step="0.1" value="1" oninput="updateLayerStyle('barrios')">
      </div>
    </div>

    <div class="layer-row">
      <div class="layer-left">
        <input type="checkbox" id="chk_salud_wgs84" onchange="toggleLayer('salud_wgs84')">
        <span>Salud</span>
      </div>
      <div class="layer-controls">
        <input type="color" id="col_salud_wgs84" value="#ed8832" onchange="updateLayerStyle('salud_wgs84')">
        <input type="range" id="op_salud_wgs84" class="range" min="0" max="1" step="0.1" value="1" oninput="updateLayerStyle('salud_wgs84')">
      </div>
    </div>

    <div class="layer-row">
      <div class="layer-left">
        <input type="checkbox" id="chk_policia_wgs84" onchange="toggleLayer('policia_wgs84')">
        <span>Polic√≠a</span>
      </div>
      <div class="layer-controls">
        <input type="color" id="col_policia_wgs84" value="#4a4e55" onchange="updateLayerStyle('policia_wgs84')">
        <input type="range" id="op_policia_wgs84" class="range" min="0" max="1" step="0.1" value="1" oninput="updateLayerStyle('policia_wgs84')">
      </div>
    </div>

    <div class="layer-row">
      <div class="layer-left">
        <input type="checkbox" id="chk_bomberos_wgs84" onchange="toggleLayer('bomberos_wgs84')">
        <span>Bomberos</span>
      </div>
      <div class="layer-controls">
        <input type="color" id="col_bomberos_wgs84" value="#c62828" onchange="updateLayerStyle('bomberos_wgs84')">
        <input type="range" id="op_bomberos_wgs84" class="range" min="0" max="1" step="0.1" value="1" oninput="updateLayerStyle('bomberos_wgs84')">
      </div>
    </div>

    <div class="layer-row">
      <div class="layer-left">
        <input type="checkbox" id="chk_alcantarillado" onchange="toggleLayer('alcantarillado')">
        <span>Alcantarillado</span>
      </div>
      <div class="layer-controls">
        <input type="color" id="col_alcantarillado" value="#1976d2" onchange="updateLayerStyle('alcantarillado')">
        <input type="range" id="op_alcantarillado" class="range" min="0" max="1" step="0.1" value="1" oninput="updateLayerStyle('alcantarillado')">
      </div>
    </div>

    <div class="small">Consejo: cambia color y transparencia para distinguir capas.</div>
  </div>
</div>

<button id="logout" onclick="logout()">Cerrar sesi√≥n</button>

<!-- Modal login -->
<div id="loginModal">
  <div id="loginBox">
    <h2>üîí Acceso Geoportal</h2>
    <div class="login-field">
      <input type="password" id="keyPrivacy" placeholder="Key Privacy">
      <button class="eye-btn" onclick="togglePrivacy()">üëÅ</button>
    </div>
    <button onclick="login()">Entrar</button>
  </div>
</div>

<script>
/* ====== Supabase ====== */
const supa = window.supabase.createClient(
 "https://bxlxciekszzsdukmahdw.supabase.co",
 "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ4bHhjaWVrc3p6c2R1a21haGR3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk0MTc3MTEsImV4cCI6MjA3NDk5MzcxMX0.pRiN8XrHBes1uAwExUpEOvvi-h6OPLfQOkTiQr_rAPg"
);

/* ====== Mapa base (Google Hybrid por defecto) ====== */
let map = L.map('map').setView([20.6767, -103.3476], 12);

// Definici√≥n de mapas base
const googleHybrid = L.tileLayer(
  'https://{s}.google.com/vt/lyrs=y&x={x}&y={y}&z={z}',
  {
    maxZoom: 20,
    subdomains: ['mt0','mt1','mt2','mt3'],
    attribution: '¬© Google Maps',
  }
);

const googleSat = L.tileLayer(
  'https://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}',
  {
    maxZoom: 20,
    subdomains: ['mt0','mt1','mt2','mt3'],
    attribution: '¬© Google Satellite',
  }
);

const osmStd = L.tileLayer(
  'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
  { maxZoom: 19, attribution: '¬© OpenStreetMap' }
);

const esriTopo = L.tileLayer(
  'https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}',
  { maxZoom: 19, attribution: '¬© Esri Topo' }
);

// Agregamos Google Hybrid como mapa base por defecto
googleHybrid.addTo(map);

// Control de capas base con opci√≥n de transparencia
const baseMaps = {
  "üõ∞Ô∏è Google Hybrid": googleHybrid,
  "üåé Google Sat√©lite": googleSat,
  "üó∫Ô∏è Esri Topogr√°fico": esriTopo,
  "üìç OSM Est√°ndar": osmStd
};

L.control.layers(baseMaps, {}, { collapsed: true }).addTo(map);


/* ====== Estado UI ====== */
function $(id){return document.getElementById(id);}
function toggleBox(id){$(id).classList.toggle("hidden");}

/* ====== Dibujo y guardado de reportes ====== */
let drawn=null, activeDraw=null;
function startDraw(type){
  if(drawn) { map.removeLayer(drawn); drawn=null; }
  if(activeDraw) activeDraw.disable();
  let drawTool=null;
  if(type==="Point") drawTool = new L.Draw.Marker(map);
  else if(type==="LineString") drawTool = new L.Draw.Polyline(map);
  else drawTool = new L.Draw.Polygon(map);
  activeDraw=drawTool; drawTool.enable();

  map.once(L.Draw.Event.CREATED, e => { drawn=e.layer; map.addLayer(drawn); });
  document.addEventListener("keydown",ev=>{ if(ev.key==="Enter"&&activeDraw){ try{ activeDraw.completeShape(); }catch{} } });
  map.on("contextmenu",()=>{ try{ activeDraw.completeShape(); }catch{} });
}
async function saveReporte(){
  if(!drawn){ alert("‚ö†Ô∏è Dibuja una geometr√≠a primero"); return; }
  const nombre = $("nombre").value.trim();
  const tipo   = $("tipo").value.trim();
  const comentarios = $("comentarios").value.trim();
  const grupoSel = $("grupoSelect").value;
  const grupo_id = grupoSel ? parseInt(grupoSel) : null;

  const geom = drawn.toGeoJSON().geometry;
  const geom_tipo = geom.type;

  const {error} = await supa.from("reportes").insert([{ nombre, tipo_requerimiento:tipo, comentarios, geom, geom_tipo, grupo_id }]);
  if(error){ alert("‚ùå Error al guardar: " + error.message); return; }

  alert("‚úÖ Reporte guardado correctamente");
  $("nombre").value=""; $("tipo").value=""; $("comentarios").value="";
  map.removeLayer(drawn); drawn=null; activeDraw=null;
  loadGrupos(); // refresca lista
}

/* ====== Seguimiento de reportes ====== */
let reporteLayers = {};
async function addGrupo(){
  const nombre=$("grupoNombre").value.trim();
  if(!nombre) return;
  const {error} = await supa.from("grupos").insert([{nombre}]);
  if(!error){ $("grupoNombre").value=""; loadGrupos(); }
}
async function deleteGrupo(id){
  if(confirm("¬øEliminar grupo completo?")){
    await supa.from("grupos").delete().eq("id",id);
    loadGrupos();
  }
}
async function deleteReporte(r){
  if(confirm("¬øEliminar este reporte?")){
    await supa.from("reportes").delete().eq("id",r.id);
    if(reporteLayers["r"+r.id]){ map.removeLayer(reporteLayers["r"+r.id]); delete reporteLayers["r"+r.id]; }
    loadGrupos();
  }
}
async function loadGrupos(){
  const { data: grupos } = await supa.from("grupos").select("*").order("id",{ascending:true});
  const ul = $("listaGrupos");
  const sel = $("grupoSelect");
  ul.innerHTML = "";
  sel.innerHTML = "<option value=''>Sin grupo</option>";

  for(const g of grupos){
    const li = document.createElement("li");
    li.className = "grupo";

    const header = document.createElement("div");
    header.style.display="flex";
    header.style.alignItems="center";
    header.style.justifyContent="space-between";
    header.innerHTML = `<span class="grupo-nombre" onclick="toggleReportes(${g.id})">üìÇ ${g.nombre}</span>
                        <button onclick="deleteGrupo(${g.id})" class="reporte-del">üóë</button>`;

    const repList = document.createElement("ul");
    repList.id = "rep_"+g.id;
    repList.className = "reporte-lista";

    li.appendChild(header);
    li.appendChild(repList);
    ul.appendChild(li);

    const op=document.createElement("option");
    op.value=g.id; op.textContent=g.nombre; sel.appendChild(op);
  }
}
async function toggleReportes(grupo_id){
  const list = $("rep_"+grupo_id);
  if(!list) return;
  if(list.classList.contains("open")){ list.classList.remove("open"); list.innerHTML=""; return; }

  const { data: reportes } = await supa.from("reportes").select("*").eq("grupo_id",grupo_id);
  list.innerHTML="";
  list.classList.add("open");
  for(const r of reportes){
    const li = document.createElement("li");
    li.className = "reporte-item";

    const label = document.createElement("label");
    label.className = "reporte-inline";
    const chk = document.createElement("input");
    chk.type="checkbox";
    chk.onchange = () => toggleReporte(r, chk.checked);
    const txt = document.createElement("span");
    txt.textContent = r.nombre; // ‚Äúenrique‚Äù, etc.

    label.appendChild(chk);
    label.appendChild(txt);

    const del = document.createElement("button");
    del.className="reporte-del";
    del.textContent="üóë";
    del.onclick = () => deleteReporte(r);

    li.appendChild(label);
    li.appendChild(del);
    list.appendChild(li);
  }
}
function toggleReporte(r,visible){
  const key="r"+r.id;
  if(visible){
    const lyr=L.geoJSON(r.geom,{color:'#ed8832'}).bindPopup(`<b>${r.nombre}</b><br>${r.tipo_requerimiento||''}<br>${r.comentarios||''}`).addTo(map);
    reporteLayers[key]=lyr;
  }else{
    if(reporteLayers[key]){ map.removeLayer(reporteLayers[key]); delete reporteLayers[key]; }
  }
}

/* ====== Capas: encendido, color y transparencia ====== */
const layers = {};
const layerStyle = {
  barrios:          { color:'#59c1b2', weight:1, fillColor:'#59c1b2', opacity:1, fillOpacity:1, type:'polygon', table:'barrios' },
  salud_wgs84:      { color:'#ed8832', radius:5, opacity:1, fillOpacity:1, type:'point',   table:'salud_wgs84' },
  policia_wgs84:    { color:'#4a4e55', radius:5, opacity:1, fillOpacity:1, type:'point',   table:'policia_wgs84' },
  bomberos_wgs84:   { color:'#c62828', radius:5, opacity:1, fillOpacity:1, type:'point',   table:'bomberos_wgs84' },
  alcantarillado:   { color:'#1976d2', weight:2, opacity:1, type:'line', table:'alcantarillado' }
};

async function toggleLayer(name){
  const chk = $("chk_"+name);
  if(chk.checked){
    if(!layers[name]){ await loadLayer(name); }
    if(layers[name]) layers[name].addTo(map);
  }else{
    if(layers[name]) map.removeLayer(layers[name]);
  }
}
async function loadLayer(name){
  const meta = layerStyle[name];
  if(!meta) return;
  const { data, error } = await supa.from(meta.table).select("geom");
  if(error || !data) return;

  const styleFn = feature => {
    if(meta.type==='polygon'){
      return { color: meta.color, weight: meta.weight||1, fillColor: meta.color, opacity: meta.opacity, fillOpacity: meta.fillOpacity };
    }else if(meta.type==='line'){
      return { color: meta.color, weight: meta.weight||2, opacity: meta.opacity };
    }else{
      // point -> no style here (handled in pointToLayer), but set opacity in setStyle after
      return { };
    }
  };

  const ptToLayer = (feature,latlng) => {
    if(meta.type==='point'){
      return L.circleMarker(latlng, {
        radius: meta.radius||5,
        color: meta.color,
        fillColor: meta.color,
        opacity: meta.opacity,
        fillOpacity: meta.fillOpacity
      });
    } else {
      return null;
    }
  };

  layers[name] = L.geoJSON(data.map(d=>d.geom), {
    style: meta.type!=='point' ? styleFn : undefined,
    pointToLayer: meta.type==='point' ? ptToLayer : undefined
  });
  layers[name].addTo(map);
}
function updateLayerStyle(name){
  const meta = layerStyle[name];
  if(!meta) return;
  const col = $("col_"+name)?.value || meta.color;
  const op  = parseFloat($("op_"+name)?.value || 1);

  meta.color = col;
  meta.opacity = op;
  meta.fillOpacity = op;

  if(!layers[name]) return;

  if(meta.type==='point'){
    layers[name].eachLayer(m=>{
      if(m.setStyle) m.setStyle({ color: col, fillColor: col, opacity: op, fillOpacity: op });
    });
  }else if(meta.type==='line'){
    layers[name].setStyle({ color: col, opacity: op });
  }else if(meta.type==='polygon'){
    layers[name].setStyle({ color: col, fillColor: col, opacity: op, fillOpacity: op });
  }
}

/* ====== Login ====== */
function login(){
  if($("keyPrivacy").value==='DGOT2025'){
    $("loginModal").style.display='none';
    loadGrupos();
  }else alert("‚ùå Key incorrecta");
}
function logout(){ $("loginModal").style.display='flex'; $("keyPrivacy").value=''; }
function togglePrivacy(){ const i=$("keyPrivacy"); i.type=(i.type==='password')?'text':'password'; }
document.addEventListener("keydown",e=>{ if(e.key==='Enter' && $("loginModal").style.display!=='none') login(); });
</script>
</body>
</html>
